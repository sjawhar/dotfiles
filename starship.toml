format = '''$username@$hostname$terraform$aws$custom$python${custom.ephemeral_warn}
$directory$character'''

[hostname]
ssh_only = false
format = '[$ssh_symbol$hostname]($style) '

[username]
show_always = true
format = '[$user]($style)'

[custom.jj]
ignore_timeout = true
description = "The current jj status"
when = "jj root --ignore-working-copy >/dev/null 2>&1"
symbol = "ðŸ¥‹ "
command = '''
jj log --ignore-working-copy --revisions @ --no-graph --color always --limit 1 --template '
  concat(
    change_id.shortest(4),
    if(bookmarks, " " ++ bookmarks),
    surround(" | ", "",
      concat(
        if(conflict, "ðŸ’¥"),
        if(divergent, "ðŸš§"),
        if(hidden, "ðŸ‘»"),
        if(immutable, "ðŸ”’"),
      )
    ),
    " ",
    raw_escape_sequence("\x1b[1;32m"),
    if(empty, "(empty) "),
    if(description.first_line(),
      truncate_end(30, description.first_line(), "â€¦"),
      "(no description set)"
    ),
    raw_escape_sequence("\x1b[0m"),
  )
'
'''

# Show git_branch only in git repos that are NOT jj repos.
# Why the subprocess hack? Starship's built-in git_branch module doesn't support
# detect_folders to exclude .jj directories (see https://github.com/starship/starship/issues/6957).
# Until that's fixed, we use this workaround: check if we're in a jj repo first,
# and only call `starship module git_branch` if we're not.
[custom.git_branch]
when = true
command = "jj root --ignore-working-copy >/dev/null 2>&1 || starship module git_branch"
description = "Only show git_branch if we're not in a jj repo"

[python]
format = '[(\($virtualenv\) )]($style)'

[aws]
format = '[$symbol($profile )(\[$duration\] )]($style)'

[terraform]
format = '[$symbol$workspace]($style) '

[custom.ephemeral_warn]
when = "[ -f /tmp/ephemeral-storage-status ]"
command = "cat /tmp/ephemeral-storage-status"
format = "[disk: $output]($style) "
style = "bold red"
description = "Warn when pod ephemeral storage exceeds 75%"
