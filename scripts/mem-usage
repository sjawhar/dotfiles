#!/bin/sh
# Cross-platform memory usage for starship prompt.
# Works in: K8s pods, Docker containers (cgroup v2), host Linux, macOS.
# Prints "PCT% USED/TOTALG" when usage exceeds threshold, nothing otherwise.

THRESHOLD=${MEM_WARN_PERCENT:-80}

case $THRESHOLD in
  ''|*[!0-9]*) THRESHOLD=80 ;;
esac
[ "$THRESHOLD" -gt 100 ] && THRESHOLD=100
[ "$THRESHOLD" -lt 1 ] && THRESHOLD=1

# --- Containerized Linux (cgroup v2: modern K8s / Docker) ---
if [ -f /sys/fs/cgroup/memory.max ]; then
  read max < /sys/fs/cgroup/memory.max
  case $max in
    ''|*[!0-9]*) max="" ;;
  esac
  if [ -n "$max" ] && [ "$max" -gt 0 ]; then
    read current < /sys/fs/cgroup/memory.current
    pct=$((current * 100 / max))
    [ "$pct" -ge "$THRESHOLD" ] && echo "${pct}% $((current/1073741824))/$((max/1073741824))G"
    exit 0
  fi
fi

# --- Host Linux (no container memory limit) ---
if [ -f /proc/meminfo ]; then
  total=$(awk '/^MemTotal:/{print $2}' /proc/meminfo)
  avail=$(awk '/^MemAvailable:/{print $2}' /proc/meminfo)
  used=$((total - avail))
  pct=$((used * 100 / total))
  [ "$pct" -ge "$THRESHOLD" ] && echo "${pct}% $((used/1048576))/$((total/1048576))G"
  exit 0
fi

# --- macOS ---
if command -v sysctl >/dev/null 2>&1 && sysctl -n hw.memsize >/dev/null 2>&1; then
  total=$(sysctl -n hw.memsize)
  pagesize=$(sysctl -n hw.pagesize)
  eval $(vm_stat | awk -v ps="$pagesize" '
    /Pages free:/       { gsub(/\./,"",$3); free=$3 }
    /Pages inactive:/   { gsub(/\./,"",$3); inactive=$3 }
    /Pages purgeable:/  { gsub(/\./,"",$3); purgeable=$3 }
    END { printf "avail=%d\n", (free+inactive+purgeable)*ps }
  ')
  used=$((total - avail))
  pct=$((used * 100 / total))
  [ "$pct" -ge "$THRESHOLD" ] && echo "${pct}% $((used/1073741824))/$((total/1073741824))G"
  exit 0
fi
