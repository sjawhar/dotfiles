#!/bin/bash
# Secrets wrapper â€” selectively inject secrets from sops-encrypted file into commands.
#
# Usage:
#   secrets edit                        Open secrets file in editor
#   secrets list                        List secret key names
#   secrets get KEY                     Print value of a single secret
#   secrets KEY1 KEY2 -- command args   Run command with specific secrets in env
set -euo pipefail

DOTFILES_DIR="${DOTFILES_DIR:-${HOME}/.dotfiles}"
SECRETS_FILE="${DOTFILES_DIR}/secrets.env"

case "${1:-}" in
    edit) exec sops "$SECRETS_FILE" ;;
    list) sops -d --output-type dotenv "$SECRETS_FILE" | cut -d= -f1; exit ;;
    get)  sops -d --output-type dotenv "$SECRETS_FILE" | grep "^${2:?usage: secrets get KEY}=" | cut -d= -f2-; exit ;;
esac

# Collect key names until --
keys=()
while [ $# -gt 0 ] && [ "$1" != "--" ]; do
    keys+=("$1")
    shift
done
[ "${1:-}" = "--" ] && shift

if [ ${#keys[@]} -eq 0 ] || [ $# -eq 0 ]; then
    echo "Usage: secrets KEY1 [KEY2 ...] -- command [args...]" >&2
    exit 1
fi

# Decrypt once, extract requested keys
all_secrets=$(sops -d --output-type dotenv "$SECRETS_FILE")

env_args=()
for key in "${keys[@]}"; do
    val=$(echo "$all_secrets" | grep "^${key}=" | head -1 | cut -d= -f2-)
    if [ -z "$val" ]; then
        echo "secrets: secret '${key}' not found" >&2
        exit 1
    fi
    env_args+=("${key}=${val}")
done

exec env "${env_args[@]}" "$@"
